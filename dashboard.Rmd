---
title: "Project #3: Escapades in Market Risk"
author:
- Nicolas Schoonmaker
- Guillermo Delgado
- Katie Guillen
- Leanne Harper
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output: flexdashboard::flex_dashboard
subtitle: 'Lastname-Firstname_Project3'
---

```{r, include=FALSE}
# ----------------------- Setup section -------------------------
```

```{r Packages and Installers, echo=FALSE}
# Install RTools
# https://cran.rstudio.com/bin/windows/Rtools/
#
# Restart R Studio
#
# Install packages
#install.packages("dplyr")
#install.packages("rstudioapi")
#install.packages("tinytex")
#install.packages("magick")
#install.packages("plotly")
#install.packages("xts")
#install.packages("ggplot2")
#install.packages("moments")
#install.packages("matrixStats")
#install.packages("quantreg")
#install.packages("flexdashboard")
#install.packages("QRM")
#install.packages("qrmdata")
```

```{r Library Includes, echo=FALSE}
# The list of libraries to include
library(stats)
library(dplyr)
library(rstudioapi)
library(flexdashboard)
```

```{r Get current directory, echo=FALSE}
# Get the directory so we can run this from anywhere
# Get the script directory from R when running in R
if(rstudioapi::isAvailable())
{
  #print("Running in RStudio")
  script.path <- rstudioapi::getActiveDocumentContext()$path
  #(script.path)
  script.dir <- dirname(script.path)
}
if(!exists("script.dir"))
{
  #print("Running from command line")
  script.dir <- getSrcDirectory(function(x) {x})
}
#(script.dir)
```

```{r Working Directory and Data setup, echo=FALSE}
# Set my working directory
# There is a "data" folder here with the files and the script
setwd(script.dir)
# Double check the working directory
#getwd()
# Error check to ensure the working directory is set up and the data
# directory exists inside it.  Its required for this file
working_dir <- getwd()
full_path <- paste(working_dir,"/data", sep = "")
data_dir_exists <- dir.exists(full_path)
if(data_dir_exists == FALSE) {
  stop("Data directory does not exist. Make sure the working directory
       is set using setwd() and the data folder exists in it.")
}# else {
  #print("Working directory and data set up correctly")
#}
```

```{r, include=FALSE}
# ----------------------- Project code section -------------------------
```

```{r, echo=FALSE }
library(ggplot2)
library(flexdashboard)
library(shiny)
library(QRM)
library(qrmdata)
library(xts)
library(zoo)
library(psych)

rm(list = ls())

# PAGE: Exploratory Analysis
data <- na.omit(read.csv("data/metaldata.csv", header = TRUE))
prices <- data
# Compute log differences percent using as.matrix to force numeric type
data.r <- diff(log(as.matrix(data[, -1]))) * 100
# Create size and direction
size <- na.omit(abs(data.r)) # size is indicator of volatility
#head(size)
colnames(size) <- paste(colnames(size),".size", sep = "") # Teetor
direction <- ifelse(data.r > 0, 1, ifelse(data.r < 0, -1, 0)) # another indicator of volatility
colnames(direction) <- paste(colnames(direction),".dir", sep = "")
# Convert into a time series object: 
# 1. Split into date and rates
dates <- as.Date(data$DATE[-1], "%m/%d/%Y")
dates.chr <- as.character(data$DATE[-1])
#str(dates.chr)
values <- cbind(data.r, size, direction)
# for dplyr pivoting and ggplot2 need a data frame also known as "tidy data"
data.df <- data.frame(dates = dates, returns = data.r, size = size, direction = direction)
data.df.nd <- data.frame(dates = dates.chr, returns = data.r, size = size, direction = direction, stringsAsFactors = FALSE) 
#non-coerced dates for subsetting on non-date columns
# 2. Make an xts object with row names equal to the dates
data.xts <- na.omit(as.xts(values, dates)) #order.by=as.Date(dates, "%d/%m/%Y")))
#str(data.xts)
data.zr <- as.zooreg(data.xts)
returns <- data.xts # watch for this data below!

# PAGE: Market risk 
corr_rolling <- function(x) {	
  dim <- ncol(x)	
  corr_r <- cor(x)[lower.tri(diag(dim), diag = FALSE)]	
  return(corr_r)	
}
vol_rolling <- function(x){
  library(matrixStats)
  vol_r <- colSds(x)
  return(vol_r)
}
ALL.r <- data.xts[, 1:3]
window <- 90 #reactive({input$window})
corr_r <- rollapply(ALL.r, width = window, corr_rolling, align = "right", by.column = FALSE)
colnames(corr_r) <- c("nickel.copper", "nickel.aluminium", "copper.aluminium")
vol_r <- rollapply(ALL.r, width = window, vol_rolling, align = "right", by.column = FALSE)
colnames(vol_r) <- c("nickel.vol", "copper.vol", "aluminium.vol")
year <- format(index(corr_r), "%Y")
r_corr_vol <- merge(ALL.r, corr_r, vol_r, year)
# Market dependencies
#library(matrixStats)
R.corr <- apply.monthly(as.xts(ALL.r), FUN = cor)
R.vols <- apply.monthly(ALL.r, FUN = colSds) # from MatrixStats	
# Form correlation matrix for one month 	
R.corr.1 <- matrix(R.corr[20,], nrow = 3, ncol = 3, byrow = FALSE)	
rownames(R.corr.1) <- colnames(ALL.r[,1:3])	
colnames(R.corr.1) <- rownames(R.corr.1)	
#R.corr.1
R.corr <- R.corr[, c(2, 3, 6)]
colnames(R.corr) <- c("nickel.copper", "nickel.aluminium", "copper.aluminium") 	
colnames(R.vols) <- c("nickel.vols", "copper.vols", "aluminium.vols")	
R.corr.vols <- na.omit(merge(R.corr, R.vols))
R.corr.vols.logs <- na.omit(log(R.corr.vols))
year <- format(index(R.corr.vols), "%Y")
R.corr.vols.y <- data.frame(nickel.correlation = R.corr.vols[,1], copper.volatility = R.corr.vols[,5], year = year)
nickel.vols <- as.numeric(R.corr.vols[,"nickel.vols"])	
copper.vols <- as.numeric(R.corr.vols[,"copper.vols"])	
aluminium.vols <- as.numeric(R.corr.vols[,"aluminium.vols"])
```

```{r, include=FALSE}
# ----------------------- Background section -------------------------
```

Background {data-orientation=columns}
=====================================  
    
Column {data-width=650}
-------------------------------------
    
### Problem

A freight forwarder with a fleet of bulk carriers wants to optimize their portfolio in  metals markets with entry into the nickel business and use of the tramp trade.  Tramp ships are the company's "swing" option without any fixed charter or other constraint. They allow the company flexibility in managing several aspects of freight uncertainty. The call for tramp transportation is a "derived demand" based on the value of the cargoes. This value varies widely in the spot markets. The company allocates \$250 million to manage receivables. The company wants us to:

1.	Retrieve and begin to analyze data about potential commodities for diversification,
2.	Compare potential commodities with existing commodities in conventional metal spot markets,
3.	Begin to generate economic scenarios based on events that may, or may not, materialize in the commodities.
4.	The company wants to mitigate their risk by diversifying their cargo loads. This risk measures the amount of capital the company needs to maintain its portfolio of services.

### Additional details

1.	Product: Metals commodities and freight charters
2.	Metal, Company, and Geography:
    a. Nickel: MMC Norilisk, Russia
    b. Copper: Codelco, Chile and MMC Norilisk, Russia
    c. Aluminium: Vale, Brasil and Rio Tinto Alcan, Australia
3.	Customers: Ship Owners, manufacturers, traders
4.  All metals are traded on the London Metal Exchange  

Using RMD from: https://wgfoote.github.io/fin-alytics/HTML/PR03_market-risk.html  
Our code is on github at: https://github.com/nschoonm/FIN654-Project3

### Key business questions

1.	How would the performance of these commodities affect the size and timing of shipping arrangements?
2.	How would the value of new shipping arrangements affect the value of our business with our current customers?
3.	How would we manage the allocation of existing resources given we have just landed in this new market?

Column {data-width=350}
-------------------------------------
   
### Getting a response: More detailed questions

These detailed questions are answered in part by the tables, graphs and models developed - add commentary as needed to explain the outputs

1. What is the decision the freight-forwarder must make? List key business questions and data needed to help answer these questions and support the freight-forwarder's decision. Retrieve data and build financial market detail into the data story behind the questions.

2. Develop the stylized facts of the markets the freight-forwarder faces. Include level, returns, size times series plots. Calculate and display in a table the summary statistics, including quantiles, of each of these series. Use autocorrelation, partial autocorrelation, and cross correlation functions to understand some of the persistence of returns including leverage and volatility clustering effects. Use quantile regressions to develop the distribution of sensitivity of each market to spill-over effects from other markets. Interpret these stylized "facts" in terms of the business decision the freight-forwarder makes.

3. How much capital would the freight-forwarder need? Determine various measures of risk in the tail of each metal's distribution. Then figure out a loss function to develop the portfolio of risk, and the determination of risk capital the freight-forwarder might need. Confidence intervals might be used to create a risk management plan with varying tail experience thresholds.

```{r include=FALSE}
# --------------------- Data Exploration section -----------------------
```

Data Exploration {data-orientation=rows}
=====================================     
   
Row {data-height=600}
-------------------------------------

### Metals Market Percent Changes

```{r}
title.chg <- "Metals Market Percent Changes"
autoplot.zoo(data.xts[,1:3]) + ggtitle(title.chg) + ylim(-5, 5)
```

### Metals Market Percent Changes - Size

```{r}
title.chg <- "Metals Market Percent Changes - Size"
autoplot.zoo(data.xts[,4:6]) + ggtitle(title.chg) + ylim(-5, 5)
```

### Data
Descriptive Statistics
```{r}
# Add min/1st qu/median/srd qu/max of nickel/copper/alum
summary(data.r, digits=3)
```

```{r}
# Add min/1st qu/median/srd qu/max of nickel/copper/alum
summary(size, digits=3)
```
<hr>
Data Moments
```{r}
# Output the copper.size, alum.size, nickel.dir and copper.dir
# this should be mean, median, std_dev, IQR, skewness, kurtosis
#
# Load the data_moments() function
# data_moments function
# INPUTS: r vector
# OUTPUTS: list of scalars (mean, sd, median, skewness, kurtosis)
data_moments <- function(data){
  library(moments)
  library(matrixStats)
  mean.r <- colMeans(data)
  median.r <- colMedians(data)
  sd.r <- colSds(data)
  IQR.r <- colIQRs(data)
  skewness.r <- skewness(data)
  kurtosis.r <- kurtosis(data)
  result <- data.frame(mean = mean.r, median = median.r, std_dev = sd.r, IQR = IQR.r, skewness = skewness.r, kurtosis = kurtosis.r)
  return(result)
}
# Run data_moments()
answer <- data_moments(data.xts[, 4:6])
# Build pretty table
answer <- round(answer, 3)
knitr::kable(answer)

answer <- data_moments(data.xts[, 1:3])
# Build pretty table
answer <- round(answer, 3)
knitr::kable(answer)
```

Row {data-height=400}
-------------------------------------
    
### Data Insights

[Add data insights from graphs and data]
<br/><br/>

[Talk abut time frame, volatility, correlation, skewness andkurtosis]


```{r include=FALSE}
# --------------------- Volatility section -----------------------
```

Volatility {data-orientation=rows}
=====================================     
   
Row {data-height=300}
-------------------------------------

### Returns % change - ACF

```{r}
acf(coredata(data.xts[,1:3])) # returns
```

### Size Returns % change - ACF

```{r}
acf(coredata(data.xts[,4:6])) # sizes
```

Row {data-height=300}
-------------------------------------
    
### Returns % change - PACF

```{r PACF code}
# build function to repeat these routines
run_ccf <- function(one, two, main = title.chg, lag = 20, color = "red"){
  # one and two are equal length series
  # main is title
  # lag is number of lags in cross-correlation
  # color is color of dashed confidence interval bounds
  stopifnot(length(one) == length(two))
  one <- ts(one)
  two <- ts(two)
  main <- main
  lag <- lag
  color <- color
  ccf(one, two, main = main, lag.max = lag, xlab = "", ylab = "", ci.col = color)
  #end run_ccf
}
```

```{r}
# Add graphs for Returns % change - PACF
one <- ts(data.zr[,1]) # nickel
two <- ts(data.zr[,2]) # copper
title <- "nickel-copper"
run_ccf(one, two, main = title, lag = 20, color = "red")
```

### Size Returns % change - PACF

```{r}
# Add graphs for Size Returns % change - PACF
# now for volatility (sizes)
one <- data.zr[,4] # nickel
two <- data.zr[,5] # copper
title <- "Nickel-Copper: volatility"
run_ccf(one, two, main = title, lag = 20, color = "red")
```

Row {data-height=300}
-------------------------------------

### Data Insights

[Add data insights. Something about weekly vs monthly, tails, volatility, etc ]


```{r include=FALSE}
# --------------------- Correlation Sensitivity section -----------------------
```

Correlation Sensitivity {data-orientation=rows}
=====================================    

```{r Correlation code}
run_correlation_sensitivity <- function(corrAndVols, marketRisk, standardDeviation, correlationName, volatilityName){
  library(quantreg)
  taus <- seq(.05,.95,.05)	# Roger Koenker UI Bob Hogg and Allen Craig
  new_formula <- reformulate(response = marketRisk, termlabels = standardDeviation)
  fit.rq.a <- rq(new_formula, tau = taus, data = corrAndVols)	
  fit.lm.a <- lm(new_formula, data = corrAndVols)	
  plot(summary(fit.rq.a), parm = standardDeviation, main = paste(correlationName, "correlation sensitivity to", volatilityName, "volatiltiy", sep=" "))
  #(ni.cu.summary <- summary(fit.rq.a, se = "boot"))
}
```
   
Row {data-height=700}
-------------------------------------

### nickel-copper correlation sensitivity to copper volatility

```{r}
# Add graphs for nickel-copper correlation sensitivity to copper volatility
run_correlation_sensitivity(R.corr.vols, "nickel.copper", "copper.vols", "nickel-copper", "copper")
```

### copper-aluminum correlation sensitivity to aluminum volatility

```{r}
# Add graphs for copper-aluminum correlation sensitivity to aluminum volatility
run_correlation_sensitivity(R.corr.vols, "copper.aluminium", "aluminium.vols", "copper-aluminium", "aluminium")
```

### nickel-aluminum correlation sensitivity to aluminum volatility

```{r}
# Add graphs for nickel-aluminum correlation sensitivity to aluminum volatility
run_correlation_sensitivity(R.corr.vols, "nickel.aluminium", "aluminium.vols", "nickel-aluminium", "aluminium")
```

Row {data-height=300}
-------------------------------------

### Data Insights

[Add data insights. Talk about variance, spikes, positive vs negative]

```{r include=FALSE}
# --------------------- Expected Shortfall section -----------------------
```

Expected Shortfall {data-orientation=rows}
=====================================     

```{r Shortfall code}
# elementReturns = returns[,1]
expected_shortfall <- function(elementReturns)
{
  returns1 <- elementReturns
  colnames(returns1) <- "Returns" #kluge to coerce column name for df
  returns1.df <- data.frame(Returns = returns1[,1], Distribution = rep("Historical", each = length(returns1)))
    
  alpha <- 0.95 # reactive({ifelse(input$alpha.q>1,0.99,ifelse(input$alpha.q<0,0.001,input$alpha.q))})
    
  # Value at Risk
  VaR.hist <- quantile(returns1,alpha)
  VaR.text <- paste("Value at Risk =", round(VaR.hist, 2))
    
  # Determine the max y value of the density plot.
  # This will be used to place the text above the plot
  VaR.y <- max(density(returns1.df$Returns)$y)
    
  # Expected Shortfall
  ES.hist <- median(returns1[returns1 > VaR.hist])
  ES.text <- paste("Expected Shortfall =", round(ES.hist, 2))
    
  p <- ggplot(returns1.df, aes(x = Returns, fill = Distribution)) + geom_density(alpha = 0.5) + 
      geom_vline(aes(xintercept = VaR.hist), linetype = "dashed", size = 1, color = "firebrick1") + 
      geom_vline(aes(xintercept = ES.hist), size = 1, color = "firebrick1") +
      annotate("text", x = 1+ VaR.hist, y = VaR.y*1.05, label = VaR.text) +
      annotate("text", x = 1+ ES.hist, y = VaR.y*1.1, label = ES.text) + scale_fill_manual( values = "dodgerblue4")
  p
}
```
   
Row {data-height=700}
-------------------------------------

### Nickel Shortfall

```{r}
# Add graphs for Nickel Shortfall
expected_shortfall(returns[,1])
```

### Copper Shortfall

```{r}
# Add graphs for Copper Shortfall
expected_shortfall(returns[,2])
```

### Aluminum Shortfall

```{r}
# Add graphs for Aluminum Shortfall
expected_shortfall(returns[,3])
```

Row {data-height=300}
-------------------------------------

### Data Insights

[Add data insights. Which has highest risk, tails, expected shortfall values and value at risk values, what do they mean?]

```{r include=FALSE}
# --------------------- Losses section -----------------------
```

Losses {data-orientation=rows}
=====================================     
   
Row {data-height=700}
-------------------------------------

### Losses Graph

```{r Losses code}
# Now for Loss Analysis
# Get last prices
price.last <- as.numeric(tail(data[, -1], n=1))
# Specify the positions
position.rf <- c(1/3, 1/3, 1/3)
# And compute the position weights
w <- position.rf * price.last
# Fan these  the length and breadth of the risk factor series
weights.rf <- matrix(w, nrow=nrow(data.r), ncol=ncol(data.r), byrow=TRUE)
#head(rowSums((exp(data.r/100)-1)*weights.rf), n=3)
# We need to compute exp(x) - 1 for very small x: expm1 accomplishes this
#head(rowSums((exp(data.r/100)-1)*weights.rf), n=4)
loss.rf <- -rowSums(expm1(data.r/100) * weights.rf)
loss.rf.df <- data.frame(Loss = loss.rf, Distribution = rep("Historical", each = length(loss.rf)))
# Simple Value at Risk and Expected Shortfall
alpha.tolerance <- .95
VaR.hist <- quantile(loss.rf, probs=alpha.tolerance, names=FALSE)
# Just as simple Expected shortfall
ES.hist <- median(loss.rf[loss.rf > VaR.hist])
VaR.text <- paste("Value at Risk =\n", round(VaR.hist, 2)) # ="VaR"&c12
ES.text <- paste("Expected Shortfall \n=", round(ES.hist, 2))
title.text <- paste(round(alpha.tolerance*100, 0), "% Loss Limits")
# using histogram bars instead of the smooth density
p <- ggplot(loss.rf.df, aes(x = Loss, fill = Distribution)) + geom_histogram(alpha = 0.8) + geom_vline(aes(xintercept = VaR.hist), linetype = "dashed", size = 1, color = "blue") + geom_vline(aes(xintercept = ES.hist), size = 1, color = "blue") + annotate("text", x = VaR.hist, y = 40, label = VaR.text) + annotate("text", x = ES.hist, y = 20, label = ES.text) + xlim(0, 500) + ggtitle(title.text)
p
```

Row {data-height=300}
-------------------------------------

### Data Insights

[Add data insights. What is the loss limit, VAR, ES, what do they mean?  What about the distribution?]

```{r include=FALSE}
# --------------------- Extremes section -----------------------
```

Extremes {data-orientation=rows}
=====================================    

```{r Extremes code}
# mean excess plot to determine thresholds for extreme event management
data <- as.vector(loss.rf) # data is purely numeric
umin <-  min(data)         # threshold u min
umax <-  max(data) - 0.1   # threshold u max
nint <- 100                # grid length to generate mean excess plot
grid.0 <- numeric(nint)    # grid store
e <- grid.0                # store mean exceedances e
upper <- grid.0            # store upper confidence interval
lower <- grid.0            # store lower confidence interval
u <- seq(umin, umax, length = nint) # threshold u grid
alpha <- 0.95                  # confidence level
for (i in 1:nint) {
    data <- data[data > u[i]]  # subset data above thresholds
    e[i] <- mean(data - u[i])  # calculate mean excess of threshold
    sdev <- sqrt(var(data))    # standard deviation
    n <- length(data)          # sample size of subsetted data above thresholds
    upper[i] <- e[i] + (qnorm((1 + alpha)/2) * sdev)/sqrt(n) # upper confidence interval
    lower[i] <- e[i] - (qnorm((1 + alpha)/2) * sdev)/sqrt(n) # lower confidence interval
  }
mep.df <- data.frame(threshold = u, threshold.exceedances = e, lower = lower, upper = upper)
loss.excess <- loss.rf[loss.rf > u]
# Voila the plot => you may need to tweak these limits!
p <- ggplot(mep.df, aes( x= threshold, y = threshold.exceedances)) + geom_line() + geom_line(aes(x = threshold, y = lower), colour = "red") + geom_line(aes(x = threshold,  y = upper), colour = "red") + annotate("text", x = 400, y = 200, label = "upper 95%") + annotate("text", x = 200, y = 0, label = "lower 5%")
#
# GPD to describe and analyze the extremes
#
#library(QRM)
alpha.tolerance <- 0.95
u <- quantile(loss.rf, alpha.tolerance , names=FALSE)
fit <- fit.GPD(loss.rf, threshold=u) # Fit GPD to the excesses
xi.hat <- fit$par.ests[["xi"]] # fitted xi
beta.hat <- fit$par.ests[["beta"]] # fitted beta
data <- loss.rf
n.relative.excess <- length(loss.excess) / length(loss.rf) # = N_u/n
VaR.gpd <- u + (beta.hat/xi.hat)*(((1-alpha.tolerance) / n.relative.excess)^(-xi.hat)-1) 
ES.gpd <- (VaR.gpd + beta.hat-xi.hat*u) / (1-xi.hat)
n.relative.excess <- length(loss.excess) / length(loss.rf) # = N_u/n
VaR.gpd <- u + (beta.hat/xi.hat)*(((1-alpha.tolerance) / n.relative.excess)^(-xi.hat)-1) 
ES.gpd <- (VaR.gpd + beta.hat-xi.hat*u) / (1-xi.hat)
# Plot away
VaRgpd.text <- paste("GPD: Value at Risk =", round(VaR.gpd, 2))
ESgpd.text <- paste("Expected Shortfall =", round(ES.gpd, 2))
title.text <- paste(VaRgpd.text, ESgpd.text, sep = " ")
loss.plot <- ggplot(loss.rf.df, aes(x = Loss, fill = Distribution)) + geom_density(alpha = 0.2)
loss.plot <- loss.plot + geom_vline(aes(xintercept = VaR.gpd), colour = "blue", linetype = "dashed", size = 0.8)
loss.plot <- loss.plot + geom_vline(aes(xintercept = ES.gpd), colour = "blue", size = 0.8) 
  #+ annotate("text", x = 300, y = 0.0075, label = VaRgpd.text, colour = "blue") + annotate("text", x = 300, y = 0.005, label = ESgpd.text, colour = "blue")
loss.plot <- loss.plot + xlim(0,500) + ggtitle(title.text)
```
   
Row {data-height=700}
-------------------------------------

### Estimated tail probabilities for confidence interval x

```{r}
# Add graphs for Estimated tail probabilities for confidence interval x
showRM(fit, alpha = 0.99, RM = "VaR", method = "BFGS")
```

### Estimated tail probabilities for confidence interval y

```{r}
# Add graphs for Estimated tail probabilities for confidence interval y
showRM(fit, alpha = 0.99, RM = "ES", method = "BFGS") 
```

Row {data-height=300}
-------------------------------------

### Data Insights

[Add data insights. Little about GPD, high thresholds vs low, what happens?  What is it more accurate?]

```{r include=FALSE}
# --------------------- Conclusion section -----------------------
```

Conclusion {data-orientation=rows}
=====================================     
   
Row {data-height=400}
-------------------------------------

### Skills and Tools

[List Skills and Tools]

### Data Insights

[Data Insights details]

Row {data-height=600}
-------------------------------------

### Business Remarks

[Add business remarks]